---
title: "A merenda de Caxias do Sul em 2018"
output: 
  html_document:
    css: styles.css
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.cap = '',
  fig.align = 'center',
  fig.width = 10,
  fig.height = 8
)
```

```{r}
options(scipen = 999)
library(tidyverse)
library(hrbrthemes)
library(ggbeeswarm)
library(lubridate)
library(DT)
library(ggchicklet)
library(viridis)
theme_set(theme_minimal())

source(here::here("code/licitacoes/processa_licitacoes.R"))
source(here::here("code/licitacoes/processa_licitantes.R"))
source(here::here("code/licitacoes/processa_pessoas.R"))
```

```{r}
filtra_licitacoes <- function(licitacoes, palavra_chave) {
  
  licitacoes_filtradas <- licitacoes %>%  
    filter(grepl(palavra_chave, tolower(DS_OBJETO)), CD_TIPO_FASE_ATUAL == "ADH")  %>%
    select(id, CD_ORGAO, NM_ORGAO, NR_LICITACAO, 
           ANO_LICITACAO, CD_TIPO_MODALIDADE, 
           DS_OBJETO, VL_LICITACAO, DT_ABERTURA, 
           DT_HOMOLOGACAO, DT_ADJUDICACAO) %>% 
    mutate(DT_ADJUDICACAO = as.Date(DT_ADJUDICACAO),
           DT_ABERTURA = as.Date(DT_ABERTURA))
  
}
```

```{r}
anos <- c(2018)

licitacoes <- processa_licitacoes(anos)

licitacoes_cpp <- licitacoes %>% 
  filter(CD_TIPO_MODALIDADE == "CPP")

licitacoes_cx <- licitacoes %>% 
  mutate(id = paste0(CD_ORGAO, CD_TIPO_MODALIDADE, NR_LICITACAO, ANO_LICITACAO)) %>% 
  filter(NM_ORGAO == 'PM DE CAXIAS DO SUL')

merenda <- licitacoes_cx %>%  filtra_licitacoes(palavra_chave = "merenda")

cpp <- licitacoes_cx %>%  
  filter(CD_TIPO_MODALIDADE == "CPP", CD_TIPO_FASE_ATUAL == "ADH")  %>%
  select(id, CD_ORGAO, NM_ORGAO, NR_LICITACAO, 
         ANO_LICITACAO, CD_TIPO_MODALIDADE, 
         DS_OBJETO, VL_LICITACAO, DT_ABERTURA, 
         DT_HOMOLOGACAO, DT_ADJUDICACAO) %>% 
  mutate(DT_ADJUDICACAO = as.Date(DT_ADJUDICACAO),
         DT_ABERTURA = as.Date(DT_ABERTURA))

itens <- read_csv("data/licitacoes/2018/item.csv") %>% filter(CD_TIPO_MODALIDADE == "CPP")

itens_cx <- read_csv("data/licitacoes/2018/item.csv") %>% filter(CD_ORGAO == 45000)

itens_cx_cpp <- itens_cx %>% filter(CD_TIPO_MODALIDADE == "CPP") %>% 
  mutate(id = paste0(CD_ORGAO, CD_TIPO_MODALIDADE, NR_LICITACAO, ANO_LICITACAO))

contratos_cx <- read_csv("data/contratos/2018/contrato.csv") %>% filter(CD_ORGAO == 45000)
alteracao_cx <- read_csv("data/contratos/2018/alteracao.csv") %>% filter(CD_ORGAO == 45000) 

contratos_cx_cpp <- contratos_cx %>% filter(CD_TIPO_MODALIDADE == "CPP") %>% 
  mutate(id = paste0(CD_ORGAO, CD_TIPO_MODALIDADE, NR_LICITACAO, ANO_LICITACAO))
alteracao_cx_cpp <- alteracao_cx %>% filter(CD_TIPO_MODALIDADE == "CPP") %>% 
  mutate(id = paste0(CD_ORGAO, CD_TIPO_MODALIDADE, NR_LICITACAO, ANO_LICITACAO))

empenhos_cx <- read_csv("data/empenhos/2018/caxias_do_sul.csv") %>% filter(cd_orgao == 45000)

empenhos_cx_cpp <- empenhos_cx %>% filter(mod_licitacao == "CPP") %>% 
  mutate(id = paste0(cd_orgao, mod_licitacao, nr_licitacao, ano_licitacao))

censo_escolar_cx <- read_csv("data/censo_escolar/censo_escolar_2018.csv") %>% filter(municipio == "CAXIAS DO SUL")
```

### Licitações

```{r}
licitacoes_qtd <- licitacoes_cpp %>% 
  group_by(CD_ORGAO, NM_ORGAO) %>% 
  summarise(num_licitacoes = n())

licitacoes_qtd %>% 
  ggplot(aes(x = num_licitacoes)) + 
  geom_histogram(binwidth = 0.5, fill="#69b3a2") +
  geom_label(aes(x=2.2, y=122, label="Caxias do Sul está aqui"), color="#69b3a2") +
  labs(x = "Número de licitações",
       y = "Quantidade de licitações",
       title = "Quantidade de licitações por cidade",
       subtitle = "Considerando o ano de 2018") +
  theme_ipsum_rc()
```

O município de Caxias do Sul possui duas licitações da modalidade CPP e o intervalo de tempo entre a data de adjudicação e homologação foi de zero dias.

```{r}
licitacoes_cpp %>% 
  ggplot(aes(x = "", 
             y = VL_LICITACAO, 
             colour=if_else(NM_ORGAO == "PM DE CAXIAS DO SUL", "red", "black"))) +
  ggbeeswarm::geom_quasirandom(alpha = 0.8) +
  geom_label(aes(x=1, y=1550000, label="Caxias do Sul"), color="#69b3a2") +
  labs(x = "",
       y = "Valor das licitações (R$)",
       title = "Distribuição dos valores de licitações",
       subtitle = "Considerando todas as licitações CPP no RS") +
  theme_ipsum_rc() +
  theme(legend.position = "")
  
  
```

Podemos observar que o município de Caxias do Sul possui licitações com os maiores valores do tipo CPP em comparação com outros municípios do estado.

```{r}
itens_cx_cpp_tb <- itens_cx_cpp %>% 
  select(DS_ITEM, QT_ITENS, SG_UNIDADE_MEDIDA, VL_UNITARIO_ESTIMADO, VL_TOTAL_ESTIMADO) %>% 
  mutate(produto = strsplit(DS_ITEM, ":")) %>% 
  mutate(nome_item = unlist(lapply(produto, "[[", 1))) %>% 
  select(-produto)

itens_media_rs <- itens %>% 
  select(DS_ITEM, QT_ITENS, SG_UNIDADE_MEDIDA, VL_UNITARIO_ESTIMADO, VL_TOTAL_ESTIMADO) %>% 
  mutate(produto = strsplit(DS_ITEM, ",")) %>% 
  mutate(nome_item = unlist(lapply(produto, "[[", 1))) %>% 
  select(-produto) %>% 
  group_by(nome_item) %>% 
  summarise(media_produto = round(mean(VL_UNITARIO_ESTIMADO), digits = 2))

itens_tab <- left_join(itens_cx_cpp_tb, itens_media_rs, by = "nome_item")

```

Sabendo que o município possui os maiores valores de licitações CPP, logo abaixo podemos observar em que itens é gasto e a diferença de preço entre os mesmos itens com relação a média de preços no estado:

```{r}
itens_tab <- itens_tab %>% mutate(diferenca_valor = media_produto - VL_UNITARIO_ESTIMADO)

itens_tab %>% 
  arrange(desc(media_produto)) %>% 
  select(nome_item, QT_ITENS, SG_UNIDADE_MEDIDA, VL_UNITARIO_ESTIMADO, media_produto, diferenca_valor, VL_TOTAL_ESTIMADO) %>% 
  datatable(class = 'cell-border stripe',
            filter = 'top',
            rownames = FALSE, 
            options = list(pageLength = 10,
                           dom = 'ftp'),
            colnames = c("Nome", "Quantidade", "Unid. de medida", "Valor unid. estimado", "Preço médio - estado", "Diferença entre CS e RS", "Valor tot. estimado"))
```

### Contratos

#### Quem ganhou os contratos?
```{r}
cnpj_nomes <- tibble::tibble(empresa = c("COOPERATIVA DE AGRICULTORES E AGROINDUSTRIAS FAMILIARES E CAXIAS DO SUL LTDA",
                                          "COOPERATIVA ECONATIVA DE PRODUTORES ECOLOGISTAS LTDA",
                                          "COOPERATIVA AECIA DE AGRICULTORES ECOLOGISTAS LTDA",
                                          "COOPERATIVA MISTA DE AGRICULTORES FAMILIARES DE ITATI, 
                                          TERRA DE AREIA E TRES FORQUILHAS COOMAFITT",
                                          "COOPERATIVA VINICOLA GARIBALDI LTDA",
                                          "COOPERATIVA AGRICOLA MISTA NOVA PALMA LTDA"))

contratos_compl <- bind_cols(contratos_cx_cpp, cnpj_nomes)

contratos_compl %>% 
  arrange(desc(VL_CONTRATO)) %>% 
  select(NR_DOCUMENTO, empresa, DT_INICIO_VIGENCIA, DT_FINAL_VIGENCIA, DT_ASSINATURA, VL_CONTRATO) %>% 
  datatable(class = 'cell-border stripe',
            filter = 'top',
            rownames = FALSE, 
            options = list(pageLength = 10,
                           dom = 'ftp'),
            colnames = c("CNPJ", "Empresa", "Início Vigência", "Fim da vigência", "Data de assinatura", "Valor do contrato"))
```

A partir dos contratos, podemos ver, logo abaixo, se houve alguma alteração no valor:

```{r}
alt_cx_cpp <- alteracao_cx_cpp %>% select(CD_ORGAO, 
                                          NR_LICITACAO, 
                                          ANO_LICITACAO,
                                          CD_TIPO_MODALIDADE,
                                          NR_CONTRATO,
                                          ANO_CONTRATO,
                                          TP_INSTRUMENTO,
                                          SQ_EVENTO,
                                          CD_TIPO_OPERACAO,
                                          VL_ACRESCIMO,
                                          id)

alteracao_valor <- left_join(alteracao_cx_cpp, contratos_cx_cpp, by = "NR_CONTRATO", all.x = TRUE) %>% 
  mutate(vl_total = VL_ACRESCIMO + VL_CONTRATO)

alteracao_acrescimo <- alteracao_valor %>% 
  select(NR_CONTRATO, valor = VL_ACRESCIMO) %>% 
  mutate(tipo = "acrescimo")
alteracao_contrato <- alteracao_valor %>% 
  select(NR_CONTRATO, valor = VL_CONTRATO) %>% 
  mutate(tipo = "original")

alteracao_valor <- bind_rows(alteracao_acrescimo, alteracao_contrato) 

```

```{r}
alteracao_valor %>% 
  ggplot(aes(y = valor, x = as_factor(NR_CONTRATO), fill=tipo)) +
  geom_bar(position = 'dodge', stat = 'identity') +
  geom_text(aes(label = valor),
          vjust = -0.5,
          size = 3.3,
          color = "#333333") +
  labs(x = "Id. do contrato",
       y = "Valor (R$)",
       title = "Valores de contratos vs Valores de acréscimos",
       subtitle = "Considerando período de 2018") +
  theme_ipsum_rc()
 
```

